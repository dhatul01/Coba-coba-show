<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show Manager Realtime - Cloud Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">
    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center gap-3">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
            <p class="text-xs font-bold text-gray-500 uppercase tracking-widest">Menghubungkan ke Cloud...</p>
        </div>
    </div>

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Show Manager Realtime</h1>
            <p class="text-gray-600">Manajemen Link Cloud - Terhapus Otomatis Setelah Digunakan</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- KOLOM KIRI: INPUT/FORM -->
            <div class="space-y-6">
                <div id="manualSection" class="glass-card rounded-2xl p-6 shadow-xl border border-blue-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Form Jadwal</h3>
                        <div class="flex flex-col items-end">
                            <span id="linkCounter" class="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-full">
                                Sisa Link: 0
                            </span>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Show</label>
                            <select id="inShow" onchange="handleIdentifierChange()" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="">-- Pilih Show --</option>
                                <option value="Cara Meminum Ramune">Cara Meminum Ramune</option>
                                <option value="Sambil Menggandeng Erat Tanganku">Sambil Menggandeng Erat Tanganku</option>
                                <option value="Pertaruhan Cinta">Pertaruhan Cinta</option>
                                <option value="Pajama Drive">Pajama Drive</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Tanggal</label>
                                <input type="date" id="inDate" onchange="handleIdentifierChange()" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jam</label>
                                <input type="text" id="inTime" oninput="updatePreview()" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="16.00 WIB">
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-bold text-gray-500 uppercase">Link Utama</label>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold text-gray-400">AUTO</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="linkModeToggle" onchange="toggleLinkMode()" class="sr-only peer">
                                        <div class="w-8 h-4 bg-blue-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                    <span class="text-[10px] font-bold text-gray-400">MANUAL</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="inMain" oninput="updatePreview()" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none disabled:bg-gray-50 disabled:text-gray-400" placeholder="Masukkan link utama...">
                                <button id="btnNextLink" onclick="useNextLink()" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg border border-gray-200 transition-colors" title="Link Berikutnya">
                                    ðŸ”„
                                </button>
                            </div>
                            <p id="idInfo" class="text-[9px] text-blue-500 mt-1 font-mono uppercase italic"></p>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Sandi Replay</label>
                            <input type="text" id="inPass" oninput="updatePreview()" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="8Ramun3">
                        </div>

                        <div class="pt-4 border-t border-gray-100 flex justify-between">
                            <button onclick="resetLinks()" class="text-xs text-red-500 hover:underline">Reset database link</button>
                            <p class="text-[10px] text-gray-400">Link yang disalin akan terhapus selamanya</p>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6 shadow-md border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        ðŸ“‹ Antrian Link Berdasarkan Identitas
                    </h3>
                    <div id="linkDatabaseView" class="text-[10px] font-mono text-gray-500 max-h-40 overflow-y-auto space-y-1"></div>
                </div>
            </div>

            <!-- KOLOM KANAN: PREVIEW & RESULT -->
            <div class="space-y-6">
                <div class="glass-card rounded-2xl p-6 shadow-xl border-t-4 border-blue-600 sticky top-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Preview Pesan</h3>
                        <button onclick="copyAndConsume()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2">
                            Salin Format
                        </button>
                    </div>
                    <div id="formattedOutput" class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm whitespace-pre-wrap font-sans leading-relaxed text-gray-700 overflow-y-auto max-h-[500px]"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-black text-white px-8 py-3 rounded-full text-sm font-bold opacity-0 transition-opacity pointer-events-none z-50 shadow-2xl">
        Berhasil disalin!
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Inisialisasi Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Master Link Data (Fallback)
        const initialLinks = {
            "Sambil Menggandeng Erat Tanganku|2026-02-12": [
                "https://play.realtime48s.my.id/#dESIHmCyA6l5Z9k7ZGtP", "https://play.realtime48s.my.id/#K4tlp9smPQSgpcPlMRzR",
                "https://play.realtime48s.my.id/#fnT3tMHkJYUYXnauVDEP", "https://play.realtime48s.my.id/#4AU2Xa8j3mdbBmEDZTup",
                "https://play.realtime48s.my.id/#dNvIIZHc0EBkbkue8LAv", "https://play.realtime48s.my.id/#zlcfm8s8iYMDiFg4Kpyo",
                "https://play.realtime48s.my.id/#ZYqgK8khxT3lUktLBNcV", "https://play.realtime48s.my.id/#vhWM7wJriATYOEtx9sM6",
                "https://play.realtime48s.my.id/#tyLqrDcaZ9fXLHjh9GFF", "https://play.realtime48s.my.id/#XCAlVcrBJq8Jany2aqHj"
            ],
            "Pertaruhan Cinta|2026-02-15": [
                "https://play.realtime48s.my.id/#oDEl5TzFA5BP42J0emaT", "https://play.realtime48s.my.id/#YGzpmvW4WEf7l5jXmnOt",
                "https://play.realtime48s.my.id/#y2F3TNjSPyLCrvA62cgL", "https://play.realtime48s.my.id/#EQuFujeG590fIRS9BKC1",
                "https://play.realtime48s.my.id/#9E3X4sUUZDdNv4k5Dp8Q", "https://play.realtime48s.my.id/#9PbBaIZxE1A5SmVDuDVF"
            ],
            "Cara Meminum Ramune|2026-02-16": [
                "https://play.realtime48s.my.id/#iGoLJ2ci8hqzpSxvYc3F", "https://play.realtime48s.my.id/#vtseMW1ubyDT5dOeOIBS",
                "https://play.realtime48s.my.id/#A1tLJDartBManhCbJDEE", "https://play.realtime48s.my.id/#7lpMIW6LrFVyPoGygsWE"
            ]
        };

        let currentCloudData = {};
        let isManualMode = false;
        let activeLink = "";
        let currentUser = null;

        // UI Helpers
        window.toggleLinkMode = () => {
            isManualMode = document.getElementById('linkModeToggle').checked;
            const inputMain = document.getElementById('inMain');
            const btnNext = document.getElementById('btnNextLink');
            inputMain.disabled = !isManualMode;
            btnNext.disabled = isManualMode;
            if (!isManualMode) handleIdentifierChange();
            updatePreview();
        };

        window.updatePreview = () => {
            const show = document.getElementById('inShow').value || "[NAMA SHOW]";
            const rawDate = document.getElementById('inDate').value;
            const formattedDate = formatIndoDate(rawDate) || "[TANGGAL]";
            const time = document.getElementById('inTime').value || "[JAM]";
            const mainLink = isManualMode ? document.getElementById('inMain').value : (activeLink || "[LINK UTAMA]");
            const pass = document.getElementById('inPass').value || "[SANDI]";

            const template = `> *Show : ${show}*
> *Akses tanggal : ${formattedDate} jam : ${time}*

ðŸ“¢ *AKSES LIVE STREAMING pada LINK UTAMA Dan REPLAY* : 

1ï¸âƒ£ Link Utama: ðŸ”— ${mainLink}

ðŸ”—Replay ${formattedDate} : https://48realtime.github.io/Replay-Show/
ðŸ—ï¸ Sandi : ${pass}

ðŸ“§*Cara akses Live Chat* :
  Hapus cache pada browser yang akan digunakan untuk menonton live.... 

âš ï¸ *PENTING UNTUK DIPERHATIKAN*:
1 Akun = 1 Device/browser : Jangan login di dua perangkat bersamaan.
Waktu Akses: Disarankan masuk website saat live sudah dimulai.
Browser: Gunakan Chrome atau Opera untuk pengalaman terbaik.

Jika ada kendala, segera hubungi Admin. Selamat menonton! âœ¨`;

            document.getElementById('formattedOutput').innerText = template;
        };

        const formatIndoDate = (dateStr) => {
            if (!dateStr) return null;
            const dateObj = new Date(dateStr);
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            return `${String(dateObj.getDate()).padStart(2, '0')} ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
        };

        window.handleIdentifierChange = () => {
            const show = document.getElementById('inShow').value;
            const date = document.getElementById('inDate').value;
            const idInfo = document.getElementById('idInfo');
            const view = document.getElementById('linkDatabaseView');
            const counter = document.getElementById('linkCounter');

            if (show && date) {
                const key = `${show}|${date}`;
                idInfo.innerText = `ID: ${key}`;
                const links = currentCloudData[key] || [];
                counter.innerText = `Sisa Link: ${links.length}`;
                
                if (links.length > 0) {
                    activeLink = links[0];
                    if (!isManualMode) document.getElementById('inMain').value = activeLink;
                } else {
                    activeLink = "";
                    if (!isManualMode) document.getElementById('inMain').value = "";
                }

                view.innerHTML = links.map((l, i) => `
                    <div class="p-1 truncate ${i === 0 ? 'text-blue-600 font-bold bg-blue-50' : ''}">
                        ${i + 1}. ${l}
                    </div>
                `).join('') || "<span class='text-orange-500'>Link Habis / Gunakan Manual</span>";
            } else {
                idInfo.innerText = "";
                view.innerHTML = "Pilih show & tanggal...";
                counter.innerText = "Sisa Link: 0";
            }
            updatePreview();
        };

        window.useNextLink = () => {
            const show = document.getElementById('inShow').value;
            const date = document.getElementById('inDate').value;
            const key = `${show}|${date}`;
            if (currentCloudData[key] && currentCloudData[key].length > 1) {
                const links = [...currentCloudData[key]];
                const first = links.shift();
                links.push(first);
                updateCloud(key, links);
            }
        };

        window.copyAndConsume = async () => {
            const show = document.getElementById('inShow').value;
            const date = document.getElementById('inDate').value;
            const key = `${show}|${date}`;
            const text = document.getElementById('formattedOutput').innerText;
            const currentLink = isManualMode ? document.getElementById('inMain').value : activeLink;

            if (!currentLink || currentLink.includes("[")) return;

            // Copy to clipboard
            const dummy = document.createElement("textarea");
            document.body.appendChild(dummy);
            dummy.value = text;
            dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);

            // Cloud consumption
            if (!isManualMode && currentCloudData[key] && currentCloudData[key].length > 0) {
                const updatedLinks = [...currentCloudData[key]];
                updatedLinks.shift();
                await updateCloud(key, updatedLinks);
            }

            const toast = document.getElementById('toast');
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        };

        const updateCloud = async (key, newList) => {
            if (!currentUser) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'links_collection', 'main_links');
                // Gunakan updateDoc untuk menghindari penulisan ulang seluruh data jika tidak perlu
                await updateDoc(docRef, { [key]: newList });
            } catch (e) {
                console.error("Gagal mengupdate cloud:", e);
            }
        };

        window.resetLinks = async () => {
            if (!currentUser) return;
            if (confirm("Reset database? Semua link akan kembali seperti codingan awal.")) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'links_collection', 'main_links');
                    await setDoc(docRef, initialLinks);
                } catch (e) {
                    console.error("Gagal reset cloud:", e);
                }
            }
        };

        // Pola Autentikasi yang Benar (RULE 3)
        const startApp = async () => {
            try {
                // 1. Jalankan Autentikasi TERLEBIH DAHULU
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Tunggu perubahan status auth
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        // 3. Hanya jalankan query Firestore SETELAH user terautentikasi
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'links_collection', 'main_links');
                        onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                currentCloudData = docSnap.data();
                            } else {
                                // Inisialisasi jika dokumen belum ada
                                setDoc(docRef, initialLinks);
                                currentCloudData = initialLinks;
                            }
                            document.getElementById('loader').style.display = 'none';
                            handleIdentifierChange();
                        }, (err) => {
                            console.error("Firestore Error:", err);
                            // Tetap hilangkan loader meski error agar user bisa input manual
                            document.getElementById('loader').style.display = 'none';
                        });
                    }
                });
            } catch (error) {
                console.error("Inisialisasi Gagal:", error);
                document.getElementById('loader').style.display = 'none';
            }
        };

        // Jalankan Inisialisasi
        window.onload = startApp;

        // Default Date
        document.getElementById('inDate').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
